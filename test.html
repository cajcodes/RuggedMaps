<html>
<head>
 <meta charset="utf-8">
 <script src="https://ajax.googleapis.com/ajax/libs/cesiumjs/1.105/Build/Cesium/Cesium.js"></script>
 <script src="https://www.gstatic.com/gbqweb/gapi.js"></script>
 <script src="https://apis.google.com/js/client.js?onload=init"></script>
 <link href="https://ajax.googleapis.com/ajax/libs/cesiumjs/1.105/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
</head>

<body>
  <div id="cesiumContainer"></div>
  <script>
  let workers = []; // Initialize workers array

  window.init = function() {
    gapi.client.init({
      apiKey: 'AIzaSyDPHUQWA0vwTxQE48-3eodmnNa844ou_K0',
      clientId: '199938292778-5sgpb377od06qocteq6h1h6tjjvjbprp.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/bigquery.readonly',
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/bigquery/v2/rest'],
    }).then(async () => {
      console.log('BigQuery client initialized.');
      const paths = await getPaths();
      workers = paths.map((path, index) => ({
        entity: viewer.entities.add({
          position: Cesium.Cartesian3.fromDegrees(path.path[0].longitude, path.path[0].latitude, -21), // Set height to 0
          point: {
            pixelSize: 10,
            color: colors[index],
          },
          label: {
            text: `Worker ${path.workerId}`,
            fillColor: colors[index],
            showBackground: true,
            backgroundColor: Cesium.Color.WHITE.withAlpha(0.7),
            font: '14px sans-serif',
            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
            pixelOffset: new Cesium.Cartesian2(0, -20),
          }
        }),
        path: path.path,
        currentPathIndex: 0
      }));
      // Update workers' positions every 5 seconds
      setInterval(() => updateWorkersPositions(paths), 5000);
    }).catch(error => {
      console.error('Error initializing BigQuery client:', error);
    });
  };

  window.onload = function() {
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1YjY2OWE1Yy0wYjc1LTQ1YTQtODMxZi1mZTQwOWQwOGEzZWYiLCJpZCI6MTUwODQ0LCJpYXQiOjE2ODgzNDY0MTh9.dEoQJsxp89FmreUbbxZiSjduEt9OKWZJC1jUJGCaI64';
    const viewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider: false,
      baseLayerPicker: false,
      requestRenderMode: true,
      // Hide the credit container
      creditContainer: document.createElement('div'),
      // Disable elements of the viewer
      animation: false, // Hides the animation widget
      geocoder: false, // Hides the geocoder widget
      timeline: false, // Hides the timeline widget
      sceneModePicker: false, // Hides the scene mode picker widget
      navigationHelpButton: true, // Hides the navigation help button
      homeButton: false, // Hides the home button
      infoBox: false, // Hides the infobox widget
      selectionIndicator: false, // Hides the selection indicator
    });
    
    viewer.scene.screenSpaceCameraController.enableRotate = true;
    viewer.scene.screenSpaceCameraController.enableTranslate = true;
    viewer.scene.screenSpaceCameraController.enableZoom = true;
    viewer.scene.screenSpaceCameraController.enableTilt = true;
    viewer.scene.screenSpaceCameraController.enableLook = true;

    viewer.scene.screenSpaceCameraController.rotateEventTypes = [
      Cesium.CameraEventType.LEFT_DRAG,
      Cesium.CameraEventType.RIGHT_DRAG,
      Cesium.CameraEventType.MIDDLE_DRAG
    ];
    
    const tileset = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
      url: "https://tile.googleapis.com/v1/3dtiles/root.json?key= AIzaSyA8C9_h4ZqzKWDRJNNG3677SYaZgZ9XSWg",
      showCreditsOnScreen: true,
    }));

    viewer.scene.globe.show = false;
    
    viewer.camera.flyTo({
    	destination : Cesium.Cartesian3.fromDegrees(-94.998571, 29.742848, 5000),
    	duration: 5
     });

    const colors = [
      Cesium.Color.RED,
      Cesium.Color.GREEN,
      Cesium.Color.BLUE,
      Cesium.Color.YELLOW,
    ]; 

  async function getPaths() {
    const query = `SELECT worker_id, longitude, latitude FROM \`gateway-data.demo_dataset.demo_table\` ORDER BY worker_id`;
    
    // Call fetchData to fetch the rows from BigQuery
    const rows = await fetchData(query);
    
    const paths = rows.reduce((acc, row) => {
      const workerId = row.f[0].v;
      const longitude = parseFloat(row.f[1].v);
      const latitude = parseFloat(row.f[2].v);
      
      // Check if worker_id already exists in the accumulated paths
      const workerIndex = acc.findIndex(path => path.workerId === workerId);
      
      if (workerIndex !== -1) {
        // If worker_id exists, add the new coordinate to its path
        acc[workerIndex].path.push({ longitude, latitude });
      } else {
        // If worker_id doesn't exist, create a new path for it
        acc.push({ workerId, path: [{ longitude, latitude }] });
      }
      
      return acc;
    }, []);
    
    return paths;
  }

  async function fetchData(query) {
    try {
      const response = await gapi.client.bigquery.jobs.query({
        projectId: 'gateway-data',
        timeoutMs: '60000',
        query: query,
        useLegacySql: false,
      });
      
      if (response.result) {
        return response.result.rows;
      } else {
        console.log('No result from BigQuery');
      }
    } catch (error) {
      console.log('BigQuery Error', error);
    }
  }

  // Function to update workers' positions
  function updateWorkersPositions(paths) {
    workers.forEach(worker => {
      worker.currentPathIndex = (worker.currentPathIndex + 1) % worker.path.length;
      const position = worker.path[worker.currentPathIndex];
      worker.entity.position = Cesium.Cartesian3.fromDegrees(position.longitude, position.latitude, 61); // Set height to 0
    });

    viewer.scene.requestRender();
  }
  </script>
</body>
</html>
